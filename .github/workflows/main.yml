name: VNC via Localhost.run

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: ubuntu-latest

    steps:
    - name: Install dependencies (XFCE + VNC + SSH)
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver openssh-client

    - name: Set up VNC password
      run: |
        mkdir -p ~/.vnc
        echo "123456" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

    - name: Start VNC Server
      run: |
        export DISPLAY=:1
        vncserver :1
        echo "VNC Server running on :1 (port 5901)"

    - name: Start SSH tunnel via localhost.run
      run: |
        echo "Starting tunnel..."
        ssh -o StrictHostKeyChecking=no -R 5901:localhost:5901 tunnel@localhost.run > tunnel.log 2>&1 &

    - name: Wait and Show tunnel log
      run: |
        sleep 10
        echo "===== Tunnel Status ====="
        cat tunnel.log || true
        echo "========================="

    - name: Keep workflow alive for 1 hour
      run: sleep 3600
