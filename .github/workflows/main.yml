name: Ollama Phi WebUI with SSH and Public URL

on:
  workflow_dispatch: # Manual trigger

jobs:
  ollama-phi:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install Ollama
      run: |
        curl https://ollama.com/install.sh | sh
        nohup ollama serve > ollama.log 2>&1 &
        sleep 10
        echo "✅ Ollama Serve started."
        pgrep ollama || (echo "❌ ERROR: Ollama not running!" && exit 1)

    - name: Pull Phi model
      run: |
        ollama pull phi || (echo "❌ ERROR: Failed to pull Phi model." && exit 1)
        echo "✅ Phi model pulled."

    - name: Run Open WebUI
      run: |
        docker run -d -p 3000:8080 \
          --add-host=host.docker.internal:host-gateway \
          -v open-webui:/app/backend/data \
          --name open-webui \
          --restart always \
          ghcr.io/open-webui/open-webui:main
        sleep 15
        echo "✅ Open WebUI running on port 3000."

    - name: Run localhost.run and expose port 3000 to public HTTP port 80
      run: |
        sudo apt-get install -y openssh-client
        ssh-keygen -t rsa -b 4096 -N "" -f id_rsa
        echo "==== SSH Public Key ===="
        cat id_rsa.pub
        echo "========================"
        echo "Sleeping 60 seconds... COPY your public key now."
        sleep 60
        echo "Starting localhost.run tunnel..."
        ssh -o StrictHostKeyChecking=yes -R 80:localhost:3000 localhost.run &
        sleep 10
        echo "✅ Tunnel created: public URL will appear in logs."
        sleep 10
        echo "✅ Localhost.run tunnel started."

    - name: Keep Action Alive
      run: |
        echo "✅ Setup complete. Keeping container alive for 6h (max GitHub Actions runtime)."
        sleep 21600
