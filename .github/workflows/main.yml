name: Ollama Phi WebUI with SSH and Public URL

on:
  workflow_dispatch: # Bisa dijalankan manual dari GitHub

jobs:
  ollama-phi:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install Ollama
      run: |
        curl https://ollama.com/install.sh | sh
        ollama serve & sleep 5

    - name: Pull Phi model
      run: |
        ollama pull phi

    - name: Install Docker & Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io docker-compose
        sudo systemctl start docker
        sudo systemctl enable docker

    - name: Run Open WebUI
      run: |
        git clone https://github.com/open-webui/open-webui.git
        cd open-webui
        docker-compose up -d
        sleep 10

    - name: Install localhost.run
      run: |
        sudo apt-get install -y openssh-client
        ssh-keygen -t rsa -b 4096 -N "" -f id_rsa
        echo "==== SSH Public Key ===="
        cat id_rsa.pub
        echo "======================="
        sleep 40
        curl -fsSL https://local.run | sh
        ./localrun http://localhost:3000 &
        sleep 5
        echo "Localhost.run URL should appear above!"

    - name: Keep Action Alive
      run: |
        echo "Setup complete. Keep container alive for 6h (max GitHub Action runtime)."
        sleep 21600
