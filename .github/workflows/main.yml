name: VNC via Localhost.run with SSH Key

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: ubuntu-latest

    steps:
    - name: Install XFCE + VNC
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver openssh-client

    - name: Set up VNC password
      run: |
        mkdir -p ~/.vnc
        echo "123456" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

    - name: Start VNC server
      run: vncserver :1

    - name: Generate SSH key and show public key
      id: sshkey
      run: |
        ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
        echo "================ SSH PUBLIC KEY ================="
        cat ~/.ssh/id_rsa.pub
        echo "================================================="
        echo "Add this key to: https://admin.localhost.run"

    - name: Start tunnel with localhost.run
      run: |
        echo "⏳ Waiting 10s to ensure you’ve added the SSH key to https://admin.localhost.run ..."
        sleep 10
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -R 5901:localhost:5901 tunnel@localhost.run > tunnel.log 2>&1 &
        sleep 5

    - name: Show tunnel log (URL VNC)
      run: |
        echo "🔗 Tunnel log output:"
        echo "================================================="
        cat tunnel.log || true
        echo "================================================="

    - name: Keep workflow alive for 1 hour
      run: sleep 3600
