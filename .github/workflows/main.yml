name: RDP via GitHub + localhost.run

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: ubuntu-latest
    name: Start RDP Session
    steps:
      - name: Install Desktop & RDP
        run: |
          sudo apt update -y
          sudo apt install -y xfce4 xfce4-goodies xrdp
          sudo systemctl enable xrdp
          sudo adduser github --gecos "" --disabled-password
          echo "github:123456" | sudo chpasswd
          sudo usermod -aG sudo github
          echo "github ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/github
          sudo systemctl restart xrdp

      - name: Generate SSH Key
        run: |
          ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
          cat ~/.ssh/id_rsa.pub

      - name: Tunnel with localhost.run (TCP 3389)
        run: |
          sudo apt install -y openssh-client
          echo "======================================"
          echo "TUNNEL READY"
          echo "Username: github"
          echo "Password: 123456"
          echo "Copy this SSH command below in your terminal:"
          echo "ssh -i <private-key-file> -R 3389:localhost:3389 ssh.localhost.run"
          echo "======================================"
          # Now actually connect
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -R 3389:localhost:3389 ssh.localhost.run || true

      - name: Keep Running
        run: sleep 21600  # 6 hours
